<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kernel Registry &mdash; kernel-launcher 0.1 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/my-styles.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="API Reference" href="../api.html" />
    <link rel="prev" title="Wisdom Files" href="wisdom.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> kernel-launcher
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../index.html">Kernel Launcher</a></li>
<li class="toctree-l1"><a class="reference internal" href="../install.html">Installation Guide</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../example.html">Examples</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="basic.html">Basic Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="wisdom.html">Wisdom Files</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Kernel Registry</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#c-source-code">C++ source code</a></li>
<li class="toctree-l3"><a class="reference internal" href="#code-explanation">Code Explanation</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#defining-kerneldescriptor">Defining KernelDescriptor</a></li>
<li class="toctree-l4"><a class="reference internal" href="#using-kernelregistry">Using KernelRegistry</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../api.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../env_vars.html">Environment Variables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../license.html">License</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/KernelTuner/kernel_launcher">Github repository</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">kernel-launcher</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../example.html">Examples</a> &raquo;</li>
      <li>Kernel Registry</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/examples/registry.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="kernel-registry">
<h1>Kernel Registry<a class="headerlink" href="#kernel-registry" title="Permalink to this heading"></a></h1>
<p>In the previous example, we saw how to use wisdom files by creating <code class="docutils literal notranslate"><span class="pre">WisdomKernel</span></code> object.
This object will compile the kernel code on the first call and the keep the kernel loaded as long as the object exists.
Typically, one would define the <code class="docutils literal notranslate"><span class="pre">WisdomKernel</span></code> object as part of a class or as a global variable.</p>
<p>However, in certain scenarios, it is inconvenient or impractical to store <code class="docutils literal notranslate"><span class="pre">WisdomKernel</span></code> objects.
In these cases, it is possible to use the <code class="docutils literal notranslate"><span class="pre">KernelRegistry</span></code>, that essentially acts like a global table of compiled kernel instances.</p>
<section id="c-source-code">
<h2>C++ source code<a class="headerlink" href="#c-source-code" title="Permalink to this heading"></a></h2>
<p>Consider the following code snippet:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;kernel_launcher.h&quot;</span><span class="cp"></span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="c1">// Namespace alias.</span>
<span class="linenos"> 4</span><span class="k">namespace</span><span class="w"> </span><span class="nn">kl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">kernel_launcher</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 5</span>
<span class="linenos"> 6</span><span class="k">class</span><span class="w"> </span><span class="nc">VectorAddDescriptor</span><span class="o">:</span><span class="w"> </span><span class="n">KernelDescriptor</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 7</span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="linenos"> 8</span><span class="w">    </span><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="o">&gt;</span><span class="w"></span>
<span class="linenos"> 9</span><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="n">VectorAddKernel</span><span class="w"> </span><span class="n">for_type</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">10</span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">VectorAddKernel</span><span class="p">(</span><span class="n">kl</span><span class="o">::</span><span class="n">type_of</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">());</span><span class="w"></span>
<span class="linenos">11</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">12</span>
<span class="linenos">13</span><span class="w">    </span><span class="n">VectorAddKernel</span><span class="p">(</span><span class="n">kl</span><span class="o">::</span><span class="n">TypeInfo</span><span class="w"> </span><span class="n">t</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="n">element_type</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="linenos">14</span>
<span class="linenos">15</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">tuning_key</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">override</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">16</span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;vector_add_&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">element_type</span><span class="p">.</span><span class="n">name</span><span class="p">();</span><span class="w"></span>
<span class="linenos">17</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">18</span>
<span class="linenos">19</span><span class="w">    </span><span class="n">kl</span><span class="o">::</span><span class="n">KernelBuilder</span><span class="w"> </span><span class="n">build</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">override</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">20</span><span class="w">        </span><span class="n">kl</span><span class="o">::</span><span class="n">KernelBuilder</span><span class="w"> </span><span class="n">builder</span><span class="p">(</span><span class="s">&quot;vector_add&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;vector_add.cu&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos">21</span>
<span class="linenos">22</span><span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">threads_per_block</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="n">tune</span><span class="p">(</span><span class="s">&quot;block_size&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="mi">64</span><span class="p">,</span><span class="w"> </span><span class="mi">128</span><span class="p">,</span><span class="w"> </span><span class="mi">256</span><span class="p">,</span><span class="w"> </span><span class="mi">512</span><span class="p">,</span><span class="w"> </span><span class="mi">1024</span><span class="p">});</span><span class="w"></span>
<span class="linenos">23</span><span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">elements_per_thread</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="n">tune</span><span class="p">(</span><span class="s">&quot;elements_per_thread&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">});</span><span class="w"></span>
<span class="linenos">24</span><span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">elements_per_block</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">threads_per_block</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">elements_per_thread</span><span class="p">;</span><span class="w"></span>
<span class="linenos">25</span>
<span class="linenos">26</span><span class="w">        </span><span class="n">builder</span><span class="w"></span>
<span class="linenos">27</span><span class="w">            </span><span class="p">.</span><span class="n">block_size</span><span class="p">(</span><span class="n">threads_per_block</span><span class="p">)</span><span class="w"></span>
<span class="linenos">28</span><span class="w">            </span><span class="p">.</span><span class="n">grid_divisors</span><span class="p">(</span><span class="n">threads_per_block</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">elements_per_thread</span><span class="p">)</span><span class="w"></span>
<span class="linenos">29</span><span class="w">            </span><span class="p">.</span><span class="n">template_args</span><span class="p">(</span><span class="n">element_type</span><span class="p">)</span><span class="w"></span>
<span class="linenos">30</span><span class="w">            </span><span class="p">.</span><span class="n">define</span><span class="p">(</span><span class="s">&quot;ELEMENTS_PER_THREAD&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">elements_per_thread</span><span class="p">);</span><span class="w"></span>
<span class="linenos">31</span>
<span class="linenos">32</span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">builder</span><span class="p">;</span><span class="w"></span>
<span class="linenos">33</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">34</span>
<span class="linenos">35</span><span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">equals</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">KernelDescriptor</span><span class="o">&amp;</span><span class="w"> </span><span class="n">other</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">override</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">36</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">VectorAddKernel</span><span class="o">*&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">other</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">37</span><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">element_type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">element_type</span><span class="p">;</span><span class="w"></span>
<span class="linenos">38</span><span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="linenos">39</span>
<span class="linenos">40</span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="linenos">41</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">42</span>
<span class="linenos">43</span><span class="w">    </span><span class="k">private</span><span class="o">:</span><span class="w"></span>
<span class="linenos">44</span><span class="w">        </span><span class="n">kl</span><span class="o">::</span><span class="n">TypeInfo</span><span class="w"> </span><span class="n">element_type</span><span class="p">;</span><span class="w"></span>
<span class="linenos">45</span><span class="p">}</span><span class="w"></span>
<span class="linenos">46</span>
<span class="linenos">47</span><span class="kt">void</span><span class="w"> </span><span class="n">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">48</span><span class="w">    </span><span class="n">kl</span><span class="o">::</span><span class="n">set_global_wisdom_directory</span><span class="p">(</span><span class="s">&quot;wisdom/&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos">49</span><span class="w">    </span><span class="n">kl</span><span class="o">::</span><span class="n">set_global_tuning_directory</span><span class="p">(</span><span class="s">&quot;tuning/&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos">50</span>
<span class="linenos">51</span><span class="w">    </span><span class="c1">// Initialize CUDA memory. This is outside the scope of kernel_launcher.</span>
<span class="linenos">52</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1000000</span><span class="p">;</span><span class="w"></span>
<span class="linenos">53</span><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">dev_A</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">dev_B</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">dev_C</span><span class="p">;</span><span class="w"></span>
<span class="linenos">54</span><span class="w">    </span><span class="cm">/* cudaMalloc, cudaMemcpy, ... */</span><span class="w"></span>
<span class="linenos">55</span>
<span class="linenos">56</span><span class="w">    </span><span class="c1">// Launch the kernel!</span>
<span class="linenos">57</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">problem_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w"></span>
<span class="linenos">58</span>
<span class="linenos">59</span><span class="w">    </span><span class="n">kl</span><span class="o">::</span><span class="n">default_registry</span><span class="p">()</span><span class="w"></span>
<span class="linenos">60</span><span class="w">        </span><span class="p">.</span><span class="n">lookup</span><span class="p">(</span><span class="n">VectorAddDescriptor</span><span class="o">::</span><span class="n">for_type</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">())</span><span class="w"></span>
<span class="linenos">61</span><span class="w">        </span><span class="p">.</span><span class="n">instantiate</span><span class="p">(</span><span class="n">problem_size</span><span class="p">)</span><span class="w"></span>
<span class="linenos">62</span><span class="w">        </span><span class="p">.</span><span class="n">launch</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">dev_C</span><span class="p">,</span><span class="w"> </span><span class="n">dev_A</span><span class="p">,</span><span class="w"> </span><span class="n">dev_B</span><span class="p">);</span><span class="w"></span>
<span class="linenos">63</span>
<span class="linenos">64</span><span class="w">    </span><span class="c1">// Or use the short equivalent syntax:</span>
<span class="linenos">65</span><span class="w">    </span><span class="n">kl</span><span class="o">::</span><span class="n">launch</span><span class="p">(</span><span class="n">VectorAddDescriptor</span><span class="o">::</span><span class="n">for_type</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(),</span><span class="w"> </span><span class="n">problem_size</span><span class="p">)(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">dev_C</span><span class="p">,</span><span class="w"> </span><span class="n">dev_A</span><span class="p">,</span><span class="w"> </span><span class="n">dev_B</span><span class="p">);</span><span class="w"></span>
<span class="linenos">66</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="code-explanation">
<h2>Code Explanation<a class="headerlink" href="#code-explanation" title="Permalink to this heading"></a></h2>
<p>The code example consists of two parts.
In the first part, a class <code class="docutils literal notranslate"><span class="pre">VectorAddDescriptor</span></code> is defined.
In the second part, this class is searched in the global kernel registry.</p>
<section id="defining-kerneldescriptor">
<h3>Defining KernelDescriptor<a class="headerlink" href="#defining-kerneldescriptor" title="Permalink to this heading"></a></h3>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 6</span><span class="k">class</span><span class="w"> </span><span class="nc">VectorAddDescriptor</span><span class="o">:</span><span class="w"> </span><span class="n">KernelDescriptor</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 7</span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="linenos"> 8</span><span class="w">    </span><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="o">&gt;</span><span class="w"></span>
<span class="linenos"> 9</span><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="n">VectorAddKernel</span><span class="w"> </span><span class="n">for_type</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">10</span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">VectorAddKernel</span><span class="p">(</span><span class="n">kl</span><span class="o">::</span><span class="n">type_of</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">());</span><span class="w"></span>
<span class="linenos">11</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">12</span>
<span class="linenos">13</span><span class="w">    </span><span class="n">VectorAddKernel</span><span class="p">(</span><span class="n">kl</span><span class="o">::</span><span class="n">TypeInfo</span><span class="w"> </span><span class="n">t</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="n">element_type</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="linenos">14</span>
<span class="linenos">15</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">tuning_key</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">override</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">16</span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;vector_add_&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">element_type</span><span class="p">.</span><span class="n">name</span><span class="p">();</span><span class="w"></span>
<span class="linenos">17</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">18</span>
<span class="linenos">19</span><span class="w">    </span><span class="n">kl</span><span class="o">::</span><span class="n">KernelBuilder</span><span class="w"> </span><span class="n">build</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">override</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">20</span><span class="w">        </span><span class="n">kl</span><span class="o">::</span><span class="n">KernelBuilder</span><span class="w"> </span><span class="n">builder</span><span class="p">(</span><span class="s">&quot;vector_add&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;vector_add.cu&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos">21</span>
<span class="linenos">22</span><span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">threads_per_block</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="n">tune</span><span class="p">(</span><span class="s">&quot;block_size&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="mi">64</span><span class="p">,</span><span class="w"> </span><span class="mi">128</span><span class="p">,</span><span class="w"> </span><span class="mi">256</span><span class="p">,</span><span class="w"> </span><span class="mi">512</span><span class="p">,</span><span class="w"> </span><span class="mi">1024</span><span class="p">});</span><span class="w"></span>
<span class="linenos">23</span><span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">elements_per_thread</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="n">tune</span><span class="p">(</span><span class="s">&quot;elements_per_thread&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">});</span><span class="w"></span>
<span class="linenos">24</span><span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">elements_per_block</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">threads_per_block</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">elements_per_thread</span><span class="p">;</span><span class="w"></span>
<span class="linenos">25</span>
<span class="linenos">26</span><span class="w">        </span><span class="n">builder</span><span class="w"></span>
<span class="linenos">27</span><span class="w">            </span><span class="p">.</span><span class="n">block_size</span><span class="p">(</span><span class="n">threads_per_block</span><span class="p">)</span><span class="w"></span>
<span class="linenos">28</span><span class="w">            </span><span class="p">.</span><span class="n">grid_divisors</span><span class="p">(</span><span class="n">threads_per_block</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">elements_per_thread</span><span class="p">)</span><span class="w"></span>
<span class="linenos">29</span><span class="w">            </span><span class="p">.</span><span class="n">template_args</span><span class="p">(</span><span class="n">element_type</span><span class="p">)</span><span class="w"></span>
<span class="linenos">30</span><span class="w">            </span><span class="p">.</span><span class="n">define</span><span class="p">(</span><span class="s">&quot;ELEMENTS_PER_THREAD&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">elements_per_thread</span><span class="p">);</span><span class="w"></span>
<span class="linenos">31</span>
<span class="linenos">32</span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">builder</span><span class="p">;</span><span class="w"></span>
<span class="linenos">33</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">34</span>
<span class="linenos">35</span><span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">equals</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">KernelDescriptor</span><span class="o">&amp;</span><span class="w"> </span><span class="n">other</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">override</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">36</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">VectorAddKernel</span><span class="o">*&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">other</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">37</span><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">element_type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">element_type</span><span class="p">;</span><span class="w"></span>
<span class="linenos">38</span><span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="linenos">39</span>
<span class="linenos">40</span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="linenos">41</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">42</span>
<span class="linenos">43</span><span class="w">    </span><span class="k">private</span><span class="o">:</span><span class="w"></span>
<span class="linenos">44</span><span class="w">        </span><span class="n">kl</span><span class="o">::</span><span class="n">TypeInfo</span><span class="w"> </span><span class="n">element_type</span><span class="p">;</span><span class="w"></span>
<span class="linenos">45</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>This part of the code defines a <code class="docutils literal notranslate"><span class="pre">KernelDescriptor</span></code>:
a class that encapsulate the information required to compile a kernel.
This class should override three methods:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">tuning_key</span></code> to obtain the tuning key</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">build</span></code> to instantiate a <code class="docutils literal notranslate"><span class="pre">KernelBuilder</span></code>,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">equals</span></code> to check for equality with another <code class="docutils literal notranslate"><span class="pre">KernelDescriptor</span></code>.</p></li>
</ul>
<p>The last method is required since a kernel registry is essentially a hash table that maps <code class="docutils literal notranslate"><span class="pre">KernelDescriptor</span></code> objects to <code class="docutils literal notranslate"><span class="pre">Kernel</span></code> objects.
The <code class="docutils literal notranslate"><span class="pre">equals</span></code> method is used to check if two keys in the hash table are equivalent.</p>
</section>
<section id="using-kernelregistry">
<h3>Using KernelRegistry<a class="headerlink" href="#using-kernelregistry" title="Permalink to this heading"></a></h3>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos">59</span><span class="w">    </span><span class="n">kl</span><span class="o">::</span><span class="n">default_registry</span><span class="p">()</span><span class="w"></span>
<span class="linenos">60</span><span class="w">        </span><span class="p">.</span><span class="n">lookup</span><span class="p">(</span><span class="n">VectorAddDescriptor</span><span class="o">::</span><span class="n">for_type</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">())</span><span class="w"></span>
<span class="linenos">61</span><span class="w">        </span><span class="p">.</span><span class="n">instantiate</span><span class="p">(</span><span class="n">problem_size</span><span class="p">)</span><span class="w"></span>
<span class="linenos">62</span><span class="w">        </span><span class="p">.</span><span class="n">launch</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">dev_C</span><span class="p">,</span><span class="w"> </span><span class="n">dev_A</span><span class="p">,</span><span class="w"> </span><span class="n">dev_B</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>Here, the vector-add kernel is searched in the registry and launched with the given arguments.
It is important to note that this code can be called multiple times from different parts of the program, but the kernel is only compiled once.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos">64</span><span class="w">    </span><span class="c1">// Or use the short equivalent syntax:</span>
<span class="linenos">65</span><span class="w">    </span><span class="n">kl</span><span class="o">::</span><span class="n">launch</span><span class="p">(</span><span class="n">VectorAddDescriptor</span><span class="o">::</span><span class="n">for_type</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(),</span><span class="w"> </span><span class="n">problem_size</span><span class="p">)(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">dev_C</span><span class="p">,</span><span class="w"> </span><span class="n">dev_A</span><span class="p">,</span><span class="w"> </span><span class="n">dev_B</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>Alternatively, it is possible to use the above short-hand syntax.
This syntax also make it is easy to replace the element type <code class="docutils literal notranslate"><span class="pre">float</span></code> to some other type such as <code class="docutils literal notranslate"><span class="pre">int</span></code>:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">kl</span><span class="o">::</span><span class="n">launch</span><span class="p">(</span><span class="n">VectorAddDescriptor</span><span class="o">::</span><span class="n">for_type</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(),</span><span class="w"> </span><span class="n">problem_size</span><span class="p">)(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">dev_C</span><span class="p">,</span><span class="w"> </span><span class="n">dev_A</span><span class="p">,</span><span class="w"> </span><span class="n">dev_B</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>It is even possible to define a templated function that passes type <code class="docutils literal notranslate"><span class="pre">T</span></code> on to <code class="docutils literal notranslate"><span class="pre">VectorAddDescriptor</span></code>, for some extra template magic:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="o">&gt;</span><span class="w"></span>
<span class="linenos">2</span><span class="kt">void</span><span class="w"> </span><span class="n">launch_vector_add</span><span class="p">(</span><span class="n">T</span><span class="o">*</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">T</span><span class="o">*</span><span class="w"> </span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">T</span><span class="o">*</span><span class="w"> </span><span class="n">B</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">3</span><span class="w">    </span><span class="n">kl</span><span class="o">::</span><span class="n">launch</span><span class="p">(</span><span class="n">VectorAddDescriptor</span><span class="o">::</span><span class="n">for_type</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(),</span><span class="w"> </span><span class="n">n</span><span class="p">)(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="w"> </span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">);</span><span class="w"></span>
<span class="linenos">4</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="wisdom.html" class="btn btn-neutral float-left" title="Wisdom Files" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../api.html" class="btn btn-neutral float-right" title="API Reference" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, The kernel-launcher Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>