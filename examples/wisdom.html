<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Wisdom Files &mdash; kernel-launcher 0.1 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/my-styles.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Kernel Registry" href="registry.html" />
    <link rel="prev" title="Basic Example" href="basic.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> kernel-launcher
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../index.html">Kernel Launcher</a></li>
<li class="toctree-l1"><a class="reference internal" href="../install.html">Installation Guide</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../example.html">Tutorial</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="basic.html">Basic Example</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Wisdom Files</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#source-code">Source code</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#vector-add-kernel-cu">vector_add_kernel.cu</a></li>
<li class="toctree-l4"><a class="reference internal" href="#main-cpp">main.cpp</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#code-explanation">Code Explanation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#export-the-kernel">Export the kernel</a></li>
<li class="toctree-l3"><a class="reference internal" href="#tune-the-kernel">Tune the kernel</a></li>
<li class="toctree-l3"><a class="reference internal" href="#import-the-wisdom">Import the wisdom</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="registry.html">Kernel Registry</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../api.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../env_vars.html">Environment Variables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../license.html">License</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/KernelTuner/kernel_launcher">Github repository</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">kernel-launcher</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a></li>
          <li class="breadcrumb-item"><a href="../example.html">Tutorial</a></li>
      <li class="breadcrumb-item active">Wisdom Files</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/examples/wisdom.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="wisdom-files">
<h1>Wisdom Files<a class="headerlink" href="#wisdom-files" title="Permalink to this heading"></a></h1>
<p>In the previous example, we saw how it was possible to compile a kernel by providing both a <code class="docutils literal notranslate"><span class="pre">KernelBuilder</span></code> instance (describing the <cite>blueprint</cite> for the kernel) and a <code class="docutils literal notranslate"><span class="pre">Config</span></code> instance (describing the configuration of the tunable parameters).</p>
<p>However, determining the optimal configuration is often difficult since it highly depends on both the <cite>problem size</cite> and the type of <cite>GPU</cite> being used.
<cite>Kernel Launcher</cite> offers a solution this problem in form of <cite>wisdom</cite> files (terminology borrowed from <a class="reference external" href="http://www.fftw.org/">FFTW</a>).</p>
<p>Let’s see this in action.</p>
<section id="source-code">
<h2>Source code<a class="headerlink" href="#source-code" title="Permalink to this heading"></a></h2>
<section id="vector-add-kernel-cu">
<h3>vector_add_kernel.cu<a class="headerlink" href="#vector-add-kernel-cu" title="Permalink to this heading"></a></h3>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="o">&gt;</span>
<span class="linenos"> 2</span><span class="n">__global__</span>
<span class="linenos"> 3</span><span class="kt">void</span><span class="w"> </span><span class="n">vector_add</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="o">*</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">T</span><span class="o">*</span><span class="w"> </span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">T</span><span class="o">*</span><span class="w"> </span><span class="n">B</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 4</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">ELEMENTS_PER_THREAD</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 5</span><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ELEMENTS_PER_THREAD</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="linenos"> 6</span>
<span class="linenos"> 7</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 8</span><span class="w">            </span><span class="n">C</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">B</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="linenos"> 9</span><span class="w">        </span><span class="p">}</span>
<span class="linenos">10</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">11</span><span class="p">}</span>
</pre></div>
</div>
</section>
<section id="main-cpp">
<h3>main.cpp<a class="headerlink" href="#main-cpp" title="Permalink to this heading"></a></h3>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;kernel_launcher.h&quot;</span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="c1">// Namespace alias.</span>
<span class="linenos"> 4</span><span class="k">namespace</span><span class="w"> </span><span class="nn">kl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">kernel_launcher</span><span class="p">;</span>
<span class="linenos"> 5</span>
<span class="linenos"> 6</span><span class="n">kl</span><span class="o">::</span><span class="n">KernelBuilder</span><span class="w"> </span><span class="nf">build_kernel</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 7</span><span class="w">    </span><span class="n">kl</span><span class="o">::</span><span class="n">KernelBuilder</span><span class="w"> </span><span class="n">builder</span><span class="p">(</span><span class="s">&quot;vector_add&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;vector_add.cu&quot;</span><span class="p">);</span>
<span class="linenos"> 8</span>
<span class="linenos"> 9</span><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">threads_per_block</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="n">tune</span><span class="p">(</span><span class="s">&quot;block_size&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="mi">64</span><span class="p">,</span><span class="w"> </span><span class="mi">128</span><span class="p">,</span><span class="w"> </span><span class="mi">256</span><span class="p">,</span><span class="w"> </span><span class="mi">512</span><span class="p">,</span><span class="w"> </span><span class="mi">1024</span><span class="p">});</span>
<span class="linenos">10</span><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">elements_per_thread</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="n">tune</span><span class="p">(</span><span class="s">&quot;elements_per_thread&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">});</span>
<span class="linenos">11</span><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">elements_per_block</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">threads_per_block</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">elements_per_thread</span><span class="p">;</span>
<span class="linenos">12</span>
<span class="linenos">13</span><span class="w">    </span><span class="n">builder</span>
<span class="linenos">14</span><span class="w">        </span><span class="p">.</span><span class="n">tuning_key</span><span class="p">(</span><span class="s">&quot;vector_add_float&quot;</span><span class="p">)</span>
<span class="linenos">15</span><span class="w">        </span><span class="p">.</span><span class="n">problem_size</span><span class="p">(</span><span class="n">kl</span><span class="o">::</span><span class="n">arg0</span><span class="p">)</span>
<span class="linenos">16</span><span class="w">        </span><span class="p">.</span><span class="n">block_size</span><span class="p">(</span><span class="n">threads_per_block</span><span class="p">)</span>
<span class="linenos">17</span><span class="w">        </span><span class="p">.</span><span class="n">grid_divisors</span><span class="p">(</span><span class="n">threads_per_block</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">elements_per_thread</span><span class="p">)</span>
<span class="linenos">18</span><span class="w">        </span><span class="p">.</span><span class="n">template_args</span><span class="p">(</span><span class="n">kl</span><span class="o">::</span><span class="n">type_of</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">())</span>
<span class="linenos">19</span><span class="w">        </span><span class="p">.</span><span class="n">define</span><span class="p">(</span><span class="s">&quot;ELEMENTS_PER_THREAD&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">elements_per_thread</span><span class="p">);</span>
<span class="linenos">20</span>
<span class="linenos">21</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">builder</span><span class="p">;</span>
<span class="linenos">22</span><span class="p">}</span>
<span class="linenos">23</span>
<span class="linenos">24</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">25</span><span class="w">    </span><span class="n">kl</span><span class="o">::</span><span class="n">set_global_wisdom_directory</span><span class="p">(</span><span class="s">&quot;wisdom/&quot;</span><span class="p">);</span>
<span class="linenos">26</span><span class="w">    </span><span class="n">kl</span><span class="o">::</span><span class="n">set_global_capture_directory</span><span class="p">(</span><span class="s">&quot;tuning/&quot;</span><span class="p">);</span>
<span class="linenos">27</span>
<span class="linenos">28</span><span class="w">    </span><span class="c1">// Define the kernel.</span>
<span class="linenos">29</span><span class="w">    </span><span class="n">kl</span><span class="o">::</span><span class="n">KernelBuilder</span><span class="w"> </span><span class="n">builder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">build_kernel</span><span class="p">();</span>
<span class="linenos">30</span><span class="w">    </span><span class="n">kl</span><span class="o">::</span><span class="n">WisdomKernel</span><span class="w"> </span><span class="n">vector_add_kernel</span><span class="p">(</span><span class="n">builder</span><span class="p">);</span>
<span class="linenos">31</span>
<span class="linenos">32</span><span class="w">    </span><span class="c1">// Initialize CUDA memory. This is outside the scope of kernel_launcher.</span>
<span class="linenos">33</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1000000</span><span class="p">;</span>
<span class="linenos">34</span><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">dev_A</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">dev_B</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">dev_C</span><span class="p">;</span>
<span class="linenos">35</span><span class="w">    </span><span class="cm">/* cudaMalloc, cudaMemcpy, ... */</span>
<span class="linenos">36</span>
<span class="linenos">37</span><span class="w">    </span><span class="c1">// Launch the kernel!</span>
<span class="linenos">38</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">problem_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="p">;</span>
<span class="linenos">39</span><span class="w">    </span><span class="n">vector_add_kernel</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">dev_C</span><span class="p">,</span><span class="w"> </span><span class="n">dev_A</span><span class="p">,</span><span class="w"> </span><span class="n">dev_B</span><span class="p">);</span>
<span class="linenos">40</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">41</span><span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<section id="code-explanation">
<h2>Code Explanation<a class="headerlink" href="#code-explanation" title="Permalink to this heading"></a></h2>
<p>Notice how this example is similar to the previous example, with some minor differences such that <code class="docutils literal notranslate"><span class="pre">kl::Kernel</span></code> has been replaced by <code class="docutils literal notranslate"><span class="pre">kl::WisdomKernel</span></code>.
We now highlight the important lines of this code example.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 6</span><span class="n">kl</span><span class="o">::</span><span class="n">KernelBuilder</span><span class="w"> </span><span class="nf">build_kernel</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 7</span><span class="w">    </span><span class="n">kl</span><span class="o">::</span><span class="n">KernelBuilder</span><span class="w"> </span><span class="n">builder</span><span class="p">(</span><span class="s">&quot;vector_add&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;vector_add.cu&quot;</span><span class="p">);</span>
<span class="linenos"> 8</span>
<span class="linenos"> 9</span><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">threads_per_block</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="n">tune</span><span class="p">(</span><span class="s">&quot;block_size&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="mi">64</span><span class="p">,</span><span class="w"> </span><span class="mi">128</span><span class="p">,</span><span class="w"> </span><span class="mi">256</span><span class="p">,</span><span class="w"> </span><span class="mi">512</span><span class="p">,</span><span class="w"> </span><span class="mi">1024</span><span class="p">});</span>
<span class="linenos">10</span><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">elements_per_thread</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="n">tune</span><span class="p">(</span><span class="s">&quot;elements_per_thread&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">});</span>
<span class="linenos">11</span><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">elements_per_block</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">threads_per_block</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">elements_per_thread</span><span class="p">;</span>
<span class="linenos">12</span>
<span class="linenos">13</span><span class="w">    </span><span class="n">builder</span>
<span class="linenos">14</span><span class="w">        </span><span class="p">.</span><span class="n">tuning_key</span><span class="p">(</span><span class="s">&quot;vector_add_float&quot;</span><span class="p">)</span>
<span class="linenos">15</span><span class="w">        </span><span class="p">.</span><span class="n">problem_size</span><span class="p">(</span><span class="n">kl</span><span class="o">::</span><span class="n">arg0</span><span class="p">)</span>
<span class="linenos">16</span><span class="w">        </span><span class="p">.</span><span class="n">block_size</span><span class="p">(</span><span class="n">threads_per_block</span><span class="p">)</span>
<span class="linenos">17</span><span class="w">        </span><span class="p">.</span><span class="n">grid_divisors</span><span class="p">(</span><span class="n">threads_per_block</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">elements_per_thread</span><span class="p">)</span>
<span class="linenos">18</span><span class="w">        </span><span class="p">.</span><span class="n">template_args</span><span class="p">(</span><span class="n">kl</span><span class="o">::</span><span class="n">type_of</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">())</span>
<span class="linenos">19</span><span class="w">        </span><span class="p">.</span><span class="n">define</span><span class="p">(</span><span class="s">&quot;ELEMENTS_PER_THREAD&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">elements_per_thread</span><span class="p">);</span>
<span class="linenos">20</span>
<span class="linenos">21</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">builder</span><span class="p">;</span>
<span class="linenos">22</span><span class="p">}</span>
</pre></div>
</div>
<p>This function creates a <code class="docutils literal notranslate"><span class="pre">KernelBuilder</span></code> object.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos">13</span><span class="w">    </span><span class="n">builder</span>
<span class="linenos">14</span><span class="w">        </span><span class="p">.</span><span class="n">tuning_key</span><span class="p">(</span><span class="s">&quot;vector_add_float&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Using a <code class="docutils literal notranslate"><span class="pre">WisdomKernel</span></code> requires the <cite>tuning key</cite> to be set.
If no tuning key is specified, then the kernel name is taken by default (which, in this example is <code class="docutils literal notranslate"><span class="pre">vector_add</span></code>).
The <cite>tuning key</cite> is a string that uniquely identifies this kernel and is used to search for the kernel’s wisdom file.
If no wisdom file can be been found, the default configuration is chosen (in this case, that will be <code class="docutils literal notranslate"><span class="pre">block_size=32,elements_per_thread=1</span></code>).</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos">25</span><span class="w">    </span><span class="n">kl</span><span class="o">::</span><span class="n">set_global_wisdom_directory</span><span class="p">(</span><span class="s">&quot;wisdom/&quot;</span><span class="p">);</span>
<span class="linenos">26</span><span class="w">    </span><span class="n">kl</span><span class="o">::</span><span class="n">set_global_capture_directory</span><span class="p">(</span><span class="s">&quot;tuning/&quot;</span><span class="p">);</span>
</pre></div>
</div>
<p>These two lines set global settings for the application.</p>
<p>The function <code class="docutils literal notranslate"><span class="pre">set_global_wisdom_directory</span></code> sets the directory containing the wisdom files.
When a kernel is compiled, this is where Kernel Launcher will search for the associated wisdom file.
In this example, Kernel Launcher will search for the file <code class="docutils literal notranslate"><span class="pre">wisdom/vector_add_float.wisdom</span></code> since <code class="docutils literal notranslate"><span class="pre">wisdim/</span></code> is the
wisdom directory and <code class="docutils literal notranslate"><span class="pre">vector_add_float</span></code> is the tuning key.</p>
<p>The function <code class="docutils literal notranslate"><span class="pre">set_global_capture_directory</span></code> sets the directory for capture files.
When capturing a kernel launch, this is where Kernel Launcher`` will store the resulting files.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="linenos">28</span><span class="w">    </span><span class="c1">// Define the kernel.</span>
<span class="linenos">29</span><span class="w">    </span><span class="n">kl</span><span class="o">::</span><span class="n">KernelBuilder</span><span class="w"> </span><span class="n">builder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">build_kernel</span><span class="p">();</span>
<span class="linenos">30</span><span class="w">    </span><span class="n">kl</span><span class="o">::</span><span class="n">WisdomKernel</span><span class="w"> </span><span class="nf">vector_add_kernel</span><span class="p">(</span><span class="n">builder</span><span class="p">);</span>
</pre></div>
</div>
<p>These lines construct the <code class="docutils literal notranslate"><span class="pre">KernelBuilder</span></code> and pass it on to the <code class="docutils literal notranslate"><span class="pre">WisdomKernel</span></code>.</p>
</section>
<section id="export-the-kernel">
<h2>Export the kernel<a class="headerlink" href="#export-the-kernel" title="Permalink to this heading"></a></h2>
<p>To tune the kernel, we first need to capture the kernel launch.
To do this, we run the program with the environment variable <code class="docutils literal notranslate"><span class="pre">KERNEL_LAUNCHER_CAPTURE</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span><span class="nv">KERNEL_LAUNCHER_CAPTURE</span><span class="o">=</span>vector_add<span class="w"> </span>./main
</pre></div>
</div>
<p>This generates a file <code class="docutils literal notranslate"><span class="pre">vector_add_1000000.json</span></code> in the directory set by <code class="docutils literal notranslate"><span class="pre">set_global_capture_directory</span></code>.</p>
<p>Alternatively, it is possible to capture several kernels at once by using the wildcard <code class="docutils literal notranslate"><span class="pre">*</span></code>.
For example, the following command export all kernels that are start with <code class="docutils literal notranslate"><span class="pre">vector_</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span><span class="nv">KERNEL_LAUNCHER_CAPTURE</span><span class="o">=</span>vector_*<span class="w"> </span>./main
</pre></div>
</div>
<p>See <a class="reference internal" href="../env_vars.html"><span class="doc">Environment Variables</span></a> for an overview and description of additional environment variables.</p>
</section>
<section id="tune-the-kernel">
<h2>Tune the kernel<a class="headerlink" href="#tune-the-kernel" title="Permalink to this heading"></a></h2>
<p>To tune the kernel, run the Python script <code class="docutils literal notranslate"><span class="pre">tune.py</span></code> in the directory <code class="docutils literal notranslate"><span class="pre">python/</span></code> which internally uses <code class="docutils literal notranslate"><span class="pre">kernel_tuner</span></code> to tune the kernel.
Use <code class="docutils literal notranslate"><span class="pre">--help</span></code> to get an overview of all available options.
For example, to tune spend 10 minutes (600 seconds) tuning the kernel for the current kernel, use the following command:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>python<span class="w"> </span>tune.py<span class="w"> </span>tuning/vector_add_1000000.json<span class="w"> </span>--output<span class="w"> </span>wisdom/<span class="w"> </span>--time<span class="w"> </span><span class="m">600</span>
</pre></div>
</div>
<p>To tune multiple kernels all at once, use a wildcard:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>python<span class="w"> </span>tune.py<span class="w"> </span>tuning/*.json<span class="w"> </span>--output<span class="w"> </span>wisdom/
</pre></div>
</div>
<p>If everything goes well, the script should run for ten minutes and eventually create a file <code class="docutils literal notranslate"><span class="pre">wisdom/vector_add_float.wisdom</span></code> containing the tuning results.
Note that it is possible to tune the same kernel for different devices and problem sizes, for which all results will be stored in the same wisdom file.
After tuning, the files in the <code class="docutils literal notranslate"><span class="pre">tuning/</span></code> directory can safely be deleted.</p>
</section>
<section id="import-the-wisdom">
<h2>Import the wisdom<a class="headerlink" href="#import-the-wisdom" title="Permalink to this heading"></a></h2>
<p>To use the wisdom file, make sure that the file <code class="docutils literal notranslate"><span class="pre">wisdom/vector_add_float.wisdom</span></code> is available and simply rerun the program.
Now, when running the program, on the first call to <code class="docutils literal notranslate"><span class="pre">vector_add_kernel</span></code>, the kernel finds the wisdom file and compiles the kernel given the optimal configuration.
To confirm that wisdom file has indeed been found, check the debugging output by define the environment variable <code class="docutils literal notranslate"><span class="pre">KERNEL_LAUNCHER_LOG=debug</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span><span class="nv">KERNEL_LAUNCHER_LOG</span><span class="o">=</span>debug<span class="w"> </span>./main

KERNEL_LAUNCHER<span class="w"> </span><span class="o">[</span>DEBUG<span class="o">]</span><span class="w"> </span>reading<span class="w"> </span>wisdom<span class="w"> </span>file<span class="w"> </span>wisdom/vector_add_float.wisdom
KERNEL_LAUNCHER<span class="w"> </span><span class="o">[</span>DEBUG<span class="o">]</span><span class="w"> </span>found<span class="w"> </span>configuration<span class="w"> </span><span class="k">for</span><span class="w"> </span>kernel<span class="w"> </span>vector_add,<span class="w"> </span>device<span class="w"> </span>NVIDIA<span class="w"> </span>A100-PCIE-40GB,<span class="w"> </span>problem<span class="w"> </span>size<span class="w"> </span><span class="o">(</span><span class="m">1000000</span>,<span class="w"> </span><span class="m">1</span>,<span class="w"> </span><span class="m">1</span><span class="o">)</span>:<span class="w"> </span><span class="o">{</span><span class="s2">&quot;block_size&quot;</span>:<span class="w"> </span><span class="m">128</span>,<span class="w"> </span><span class="s2">&quot;elements_per_thread&quot;</span>:<span class="w"> </span><span class="m">4</span><span class="o">}</span>
KERNEL_LAUNCHER<span class="w"> </span><span class="o">[</span>DEBUG<span class="o">]</span><span class="w"> </span>compiling<span class="w"> </span>kernel<span class="w"> </span><span class="o">(</span>vector_add.cu<span class="o">)</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="basic.html" class="btn btn-neutral float-left" title="Basic Example" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="registry.html" class="btn btn-neutral float-right" title="Kernel Registry" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, The kernel-launcher Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>